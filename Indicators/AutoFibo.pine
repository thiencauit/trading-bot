//@version=5
indicator("Auto Fibonacci Retracement", overlay=true, max_lines_count=500)

// Input settings
lookback = input.int(50, "Lookback Period", minval=10, maxval=500)
showLevels = input.bool(true, "Show Fibonacci Levels")
showLabels = input.bool(true, "Show Labels")

// Fibonacci levels
fib_0 = input.float(0.0, "Level 0", group="Fibonacci Levels")
fib_236 = input.float(0.236, "Level 0.236", group="Fibonacci Levels")
fib_382 = input.float(0.382, "Level 0.382", group="Fibonacci Levels")
fib_500 = input.float(0.500, "Level 0.5", group="Fibonacci Levels")
fib_618 = input.float(0.618, "Level 0.618", group="Fibonacci Levels")
fib_786 = input.float(0.786, "Level 0.786", group="Fibonacci Levels")
fib_1 = input.float(1.0, "Level 1", group="Fibonacci Levels")

// Colors
color_0 = input.color(color.new(color.red, 0), "Color 0%", group="Colors")
color_236 = input.color(color.new(color.orange, 0), "Color 23.6%", group="Colors")
color_382 = input.color(color.new(color.yellow, 0), "Color 38.2%", group="Colors")
color_500 = input.color(color.new(color.white, 0), "Color 50%", group="Colors")
color_618 = input.color(color.new(color.blue, 0), "Color 61.8%", group="Colors")
color_786 = input.color(color.new(color.purple, 0), "Color 78.6%", group="Colors")
color_1 = input.color(color.new(color.green, 0), "Color 100%", group="Colors")

// Find lowest low (ƒë√°y) and highest high (ƒë·ªânh) in lookback period
var float swingLow = na
var float swingHigh = na
var int lowBar = na
var int highBar = na

// T√¨m ƒë√°y g·∫ßn nh·∫•t
lowestPrice = ta.lowest(low, lookback)
if low == lowestPrice
    swingLow := low
    lowBar := bar_index

// T√¨m ƒë·ªânh g·∫ßn nh·∫•t
highestPrice = ta.highest(high, lookback)
if high == highestPrice
    swingHigh := high
    highBar := bar_index

// Calculate Fibonacci levels
var float level_0 = na
var float level_236 = na
var float level_382 = na
var float level_500 = na
var float level_618 = na
var float level_786 = na
var float level_1 = na

if not na(swingLow) and not na(swingHigh)
    diff = swingHigh - swingLow
    
    // Fibonacci levels t·ª´ ƒë√°y t·ªõi ƒë·ªânh (uptrend retracement)
    level_0 := swingHigh
    level_236 := swingHigh - (diff * fib_236)
    level_382 := swingHigh - (diff * fib_382)
    level_500 := swingHigh - (diff * fib_500)
    level_618 := swingHigh - (diff * fib_618)
    level_786 := swingHigh - (diff * fib_786)
    level_1 := swingLow

// Plot Fibonacci levels
plot(showLevels ? level_0 : na, "0%", color=color_0, linewidth=2, style=plot.style_line)
plot(showLevels ? level_236 : na, "23.6%", color=color_236, linewidth=1, style=plot.style_line)
plot(showLevels ? level_382 : na, "38.2%", color=color_382, linewidth=1, style=plot.style_line)
plot(showLevels ? level_500 : na, "50%", color=color_500, linewidth=2, style=plot.style_line)
plot(showLevels ? level_618 : na, "61.8%", color=color_618, linewidth=1, style=plot.style_line)
plot(showLevels ? level_786 : na, "78.6%", color=color_786, linewidth=1, style=plot.style_line)
plot(showLevels ? level_1 : na, "100%", color=color_1, linewidth=2, style=plot.style_line)

// ========================================
// ENTRY RULES AT FIBONACCI LEVELS
// ========================================

// Trading signals at Fibonacci levels
var bool inBuyZone = false
var bool inSellZone = false

// BUY SETUP (gi√° ·ªü v√πng Fibonacci 0.5-0.618)
inBuyZone := not na(level_618) and close >= level_618 and close <= level_500

// SELL SETUP (gi√° retest v·ªÅ v√πng Fibonacci sau breakout)
// Cho tr∆∞·ªùng h·ª£p downtrend, c·∫ßn t√≠nh Fibonacci t·ª´ ƒë·ªânh xu·ªëng ƒë√°y
inSellZone := not na(level_382) and close <= level_382 and close >= level_236

// Additional indicators for entry confirmation
ema5 = ta.ema(close, 5)
ema10 = ta.ema(close, 10)
ema20 = ta.ema(close, 20)

rsi = ta.rsi(close, 14)
[macdLine, signalLine, histLine] = ta.macd(close, 12, 26, 9)

// LONG ENTRY CONDITIONS (t·∫°i v√πng Fibo 0.5-0.618)
// Theo quy t·∫Øc: ∆∞u ti√™n 0.5‚Äì0.618 tr√πng OB + ‚â•3 ƒëi·ªÅu ki·ªán trigger
longCondition1 = inBuyZone
longCondition2 = ema5 > ema10 and ema10 > ema20 // EMA bullish
longCondition3 = rsi > 50 or (rsi < 50 and rsi > rsi[1] and rsi[1] > rsi[2]) // RSI bullish or divergence
longCondition4 = macdLine > signalLine or (histLine > histLine[1]) // MACD bullish
longCondition5 = close > open // Bullish candle

// Count conditions met
var int longScore = 0
if longCondition1
    longScore := 1
else
    longScore := 0

if longCondition2
    longScore += 1
if longCondition3
    longScore += 1
if longCondition4
    longScore += 1
if longCondition5
    longScore += 1

// LONG signal: c·∫ßn √≠t nh·∫•t 3/5 ƒëi·ªÅu ki·ªán (theo rule ‚â•3 trigger)
var string lastSignalType = "" // Theo d√µi l·ªánh cu·ªëi: "LONG" ho·∫∑c "SHORT"
var bool prevLongSignal = false

// Ch·ªâ cho ph√©p LONG n·∫øu l·ªánh tr∆∞·ªõc kh√¥ng ph·∫£i LONG (lu√¢n phi√™n)
longSignal = longScore >= 3 and not prevLongSignal and lastSignalType != "LONG"
if longSignal
    prevLongSignal := true
    lastSignalType := "LONG"
if not inBuyZone
    prevLongSignal := false

// SHORT ENTRY CONDITIONS (t·∫°i v√πng Fibo retest)
shortCondition1 = inSellZone
shortCondition2 = ema5 < ema10 and ema10 < ema20 // EMA bearish
shortCondition3 = rsi < 50 or (rsi > 50 and rsi < rsi[1] and rsi[1] < rsi[2]) // RSI bearish or divergence
shortCondition4 = macdLine < signalLine or (histLine < histLine[1]) // MACD bearish
shortCondition5 = close < open // Bearish candle

// Count conditions met
var int shortScore = 0
if shortCondition1
    shortScore := 1
else
    shortScore := 0

if shortCondition2
    shortScore += 1
if shortCondition3
    shortScore += 1
if shortCondition4
    shortScore += 1
if shortCondition5
    shortScore += 1

// SHORT signal: c·∫ßn √≠t nh·∫•t 3/5 ƒëi·ªÅu ki·ªán
var bool prevShortSignal = false

// Ch·ªâ cho ph√©p SHORT n·∫øu l·ªánh tr∆∞·ªõc kh√¥ng ph·∫£i SHORT (lu√¢n phi√™n)
shortSignal = shortScore >= 3 and not prevShortSignal and lastSignalType != "SHORT"
if shortSignal
    prevShortSignal := true
    lastSignalType := "SHORT"
if not inSellZone
    prevShortSignal := false

// // Plot entry signals
// plotshape(longSignal, "LONG Entry", shape.triangleup, location.belowbar, 
//      color.new(color.lime, 0), size=size.normal, text="BUY")
// plotshape(shortSignal, "SHORT Entry", shape.triangledown, location.abovebar, 
//      color.new(color.red, 0), size=size.normal, text="SELL")

// Calculate Stop Loss and Take Profit levels
// SL: d∆∞·ªõi ƒë√°y OB (100% Fibo) + buffer
// TP: 1R, 2R, 3R theo quy t·∫Øc
var float longSL = na
var float longTP1 = na
var float longTP2 = na
var float longTP3 = na

if longSignal
    longSL := level_1 - (level_1 * 0.002) // SL d∆∞·ªõi swing low + 0.2% buffer
    distance = close - longSL
    longTP1 := close + (distance * 1) // 1R
    longTP2 := close + (distance * 2) // 2R
    longTP3 := close + (distance * 3) // 3R

var float shortSL = na
var float shortTP1 = na
var float shortTP2 = na
var float shortTP3 = na

if shortSignal
    shortSL := level_0 + (level_0 * 0.002) // SL tr√™n swing high + 0.2% buffer
    distance = shortSL - close
    shortTP1 := close - (distance * 1) // 1R
    shortTP2 := close - (distance * 2) // 2R
    shortTP3 := close - (distance * 3) // 3R

// Display entry info
if longSignal
    label.new(bar_index, low, 
         "Buy: " + str.tostring(close, format.mintick),
         style=label.style_label_up, color=color.new(color.green, 20), 
         textcolor=color.white, size=size.small)

if shortSignal
    label.new(bar_index, high, 
         "Sell: " + str.tostring(close, format.mintick),
         style=label.style_label_down, color=color.new(color.red, 20), 
         textcolor=color.white, size=size.small)

// Alerts for entry signals
alertcondition(longSignal, "LONG Entry at Fibo", "üü¢ LONG t·∫°i v√πng Fibonacci {{ticker}} - Ki·ªÉm tra ƒëi·ªÅu ki·ªán entry")
alertcondition(shortSignal, "SHORT Entry at Fibo", "üî¥ SHORT t·∫°i v√πng Fibonacci {{ticker}} - Ki·ªÉm tra ƒëi·ªÅu ki·ªán entry")

// Alerts for Fibonacci touch
alertcondition(close <= level_618 and close[1] > level_618, "Price at 61.8%", "Gi√° ch·∫°m Fibonacci 61.8% - V√πng v√†o l·ªánh golden")
alertcondition(close <= level_500 and close[1] > level_500, "Price at 50%", "Gi√° ch·∫°m Fibonacci 50% - V√πng v√†o l·ªánh")
alertcondition(close <= level_786 and close[1] > level_786, "Price at 78.6%", "Gi√° ch·∫°m Fibonacci 78.6% - B·∫Øt s·ªõm")