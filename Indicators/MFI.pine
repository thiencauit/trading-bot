//@version=6
indicator(title="Money Flow Index", shorttitle="MFI", format=format.price, precision=2, timeframe="", timeframe_gaps=true)
length = input.int(title="Length", defval=14, minval=1, maxval=2000)
src = hlc3
mf = ta.mfi(src, length)

// Detect peaks and valleys
pivot_lookback = input.int(5, "Pivot Lookback", minval=1)

// Find pivot highs (peaks) and pivot lows (valleys)
pivotHigh = ta.pivothigh(mf, pivot_lookback, pivot_lookback)
pivotLow = ta.pivotlow(mf, pivot_lookback, pivot_lookback)

// Store previous peaks and valleys for divergence detection
var float lastPeakValue = na
var float prevPeakValue = na
var float lastValleyValue = na
var float prevValleyValue = na

// Update peak values
if not na(pivotHigh)
    prevPeakValue := lastPeakValue
    lastPeakValue := pivotHigh

// Update valley values
if not na(pivotLow)
    prevValleyValue := lastValleyValue
    lastValleyValue := pivotLow

// Overbought/Oversold levels
overbought_level = input.int(70, "Overbought Level", minval=50, maxval=100)
oversold_level = input.int(25, "Oversold Level", minval=0, maxval=50)

// Lower high: current peak is lower than previous peak (bearish)
lowerHigh = not na(lastPeakValue) and not na(prevPeakValue) and lastPeakValue < prevPeakValue

// Higher low: current valley is higher than previous valley (bullish)
higherLow = not na(lastValleyValue) and not na(prevValleyValue) and lastValleyValue > prevValleyValue

// Variables to track overbought/oversold states
var bool wasOverbought = false
var bool wasOversold = false

// Update overbought/oversold tracking
if mf > overbought_level
    wasOverbought := true
if mf < oversold_level
    wasOversold := true

// Signal conditions
// BUY: MFI vượt lên trên oversold (sau khi đã ở dưới oversold)
buyCondition = wasOversold and mf > oversold_level

// SELL: MFI giảm xuống dưới overbought (sau khi đã ở trên overbought)
sellCondition = wasOverbought and mf < overbought_level

// Generate signals without alternation requirement
buySignal = buyCondition
sellSignal = sellCondition

// Reset state tracking after signal
if buySignal
    wasOversold := false
if sellSignal
    wasOverbought := false

// Plot MFI
plot(mf, "MF", color=#7E57C2, linewidth=2)
overbought=hline(overbought_level, title="Overbought", color=#787B86)
hline(50, "Middle Band", color=color.new(#787B86, 50))
oversold=hline(oversold_level, title="Oversold", color=#787B86)
fill(overbought, oversold, color=color.rgb(126, 87, 194, 90), title="Background")

// Plot signals with text
plotshape(buySignal, title="Strong BUY", text="BUY", style=shape.labelup, location=location.bottom, color=color.new(color.green, 0), textcolor=color.white, size=size.normal)
plotshape(sellSignal, title="Strong SELL", text="SELL", style=shape.labeldown, location=location.top, color=color.new(color.red, 0), textcolor=color.white, size=size.normal)

// Plot pivot points for visualization
plotshape(pivotHigh, "Peak", shape.diamond, location.absolute, color.red, size=size.tiny, offset=-pivot_lookback)
plotshape(pivotLow, "Valley", shape.diamond, location.absolute, color.green, size=size.tiny, offset=-pivot_lookback)

// Alerts
alertcondition(buySignal, title="MFI Buy Signal", message="MFI Buy: Oversold bounce or Higher Low")
alertcondition(sellSignal, title="MFI Sell Signal", message="MFI Sell: Overbought reversal or Lower High")