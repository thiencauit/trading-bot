//@version=6
indicator("Triple EMA (5, 10, 20)", shorttitle="3EMA", overlay=true)

// Input settings
ema5Length = input.int(5, "EMA 5 Period", minval=1, group="EMA Settings")
ema10Length = input.int(10, "EMA 10 Period", minval=1, group="EMA Settings")
ema20Length = input.int(20, "EMA 20 Period", minval=1, group="EMA Settings")

// Color settings
ema5Color = input.color(color.new(#00ff00, 0), "EMA 5 Color", group="Display Settings")
ema10Color = input.color(color.new(#ffff00, 0), "EMA 10 Color", group="Display Settings")
ema20Color = input.color(color.new(#ff0000, 0), "EMA 20 Color", group="Display Settings")

lineWidth = input.int(1, "Line Width", minval=1, maxval=5, group="Display Settings")

// Calculate EMAs
ema5 = ta.ema(close, ema5Length)
ema10 = ta.ema(close, ema10Length)
ema20 = ta.ema(close, ema20Length)

// Plot EMAs
plot(ema5, title="EMA 5", color=ema5Color, linewidth=lineWidth)
plot(ema10, title="EMA 10", color=ema10Color, linewidth=lineWidth)
plot(ema20, title="EMA 20", color=ema20Color, linewidth=lineWidth)

// Trend identification
bullishTrend = ema5 > ema10 and ema10 > ema20
bearishTrend = ema5 < ema10 and ema10 < ema20

// Check if EMAs are too close (tangled/consolidation) - using percentage distance
emaSpreadThreshold = input.float(0.5, "EMA Spread Threshold (%)", minval=0.1, maxval=5.0, step=0.1, group="Signal Filter", tooltip="Minimum distance between EMAs to allow signals. Higher value = more separation required")
ema5_10_distance = math.abs(ema5 - ema10) / ema10 * 100
ema10_20_distance = math.abs(ema10 - ema20) / ema20 * 100
emasTangled = ema5_10_distance < emaSpreadThreshold or ema10_20_distance < emaSpreadThreshold

// Background color for trend
bgcolor(bullishTrend ? color.new(color.green, 95) : bearishTrend ? color.new(color.red, 95) : na, title="Trend Background")
bgcolor(emasTangled ? color.new(color.gray, 90) : na, title="Consolidation Warning")

// Crossover signals
ema5CrossAbove10 = ta.crossover(ema5, ema10)
ema5CrossBelow10 = ta.crossunder(ema5, ema10)
ema10CrossAbove20 = ta.crossover(ema10, ema20)
ema10CrossBelow20 = ta.crossunder(ema10, ema20)

// Plot signals
plotshape(ema5CrossAbove10, title="EMA 5 Cross Above 10", style=shape.triangleup, location=location.belowbar, color=color.new(color.lime, 0), size=size.tiny)
plotshape(ema5CrossBelow10, title="EMA 5 Cross Below 10", style=shape.triangledown, location=location.abovebar, color=color.new(color.orange, 0), size=size.tiny)

plotshape(ema10CrossAbove20, title="EMA 10 Cross Above 20", style=shape.circle, location=location.belowbar, color=color.new(color.green, 0), size=size.small)
plotshape(ema10CrossBelow20, title="EMA 10 Cross Below 20", style=shape.circle, location=location.abovebar, color=color.new(color.red, 0), size=size.small)

// Buy/Sell signals based on EMA crossovers
// Only generate signals when EMAs are NOT tangled (clear trend direction)
buySignal = ta.crossover(ema5, ema20) and not emasTangled
sellSignal = ta.crossunder(ema5, ema20) and not emasTangled

plotshape(buySignal, title="BUY", text="BUY", style=shape.labelup, location=location.belowbar, color=color.new(color.green, 0), textcolor=color.white, size=size.normal)
plotshape(sellSignal, title="SELL", text="SELL", style=shape.labeldown, location=location.abovebar, color=color.new(color.red, 0), textcolor=color.white, size=size.normal)

// Alerts
alertcondition(ema5CrossAbove10, title="EMA 5 Cross Above 10", message="EMA 5 crossed above EMA 10")
alertcondition(ema5CrossBelow10, title="EMA 5 Cross Below 10", message="EMA 5 crossed below EMA 10")
alertcondition(ema10CrossAbove20, title="EMA 10 Cross Above 20", message="EMA 10 crossed above EMA 20")
alertcondition(ema10CrossBelow20, title="EMA 10 Cross Below 20", message="EMA 10 crossed below EMA 20")
alertcondition(buySignal, title="BUY Signal", message="BUY: EMA 5 crossed above EMA 20")
alertcondition(sellSignal, title="SELL Signal", message="SELL: EMA 5 crossed below EMA 20")
