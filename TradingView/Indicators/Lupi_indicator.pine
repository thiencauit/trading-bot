//@version=5
indicator("Lupi Complete Trading System", overlay=true, max_boxes_count=500, max_lines_count=500)

// ═══════════════════════════════════════════════════════════════════════════
// INPUT SETTINGS
// ═══════════════════════════════════════════════════════════════════════════

// EMA Settings
ema5 = input.int(5, "EMA 5", group="EMAs")
ema10 = input.int(10, "EMA 10", group="EMAs")
ema20 = input.int(20, "EMA 20", group="EMAs")
ema50 = input.int(50, "EMA 50", group="EMAs")
ema100 = input.int(100, "EMA 100", group="EMAs")
ema200 = input.int(200, "EMA 200", group="EMAs")

// MACD Settings
macdFast = input.int(12, "MACD Fast", group="MACD")
macdSlow = input.int(26, "MACD Slow", group="MACD")
macdSignal = input.int(9, "MACD Signal", group="MACD")

// RSI Settings
rsiLength = input.int(14, "RSI Length", group="RSI")
rsiOverbought = input.int(70, "RSI Overbought", group="RSI")
rsiOversold = input.int(30, "RSI Oversold", group="RSI")

// MFI Settings
mfiLength = input.int(14, "MFI Length", group="MFI")
mfiOverbought = input.int(70, "MFI Overbought", group="MFI")
mfiOversold = input.int(25, "MFI Oversold", group="MFI")

// SuperTrend Settings
atrPeriod = input.int(10, "SuperTrend ATR", group="SuperTrend")
atrMultiplier = input.float(3.0, "SuperTrend Factor", group="SuperTrend")

// Bollinger Bands Settings
bbLength = input.int(20, "BB Length", group="Bollinger Bands")
bbMult = input.float(2.0, "BB StdDev", group="Bollinger Bands")

// Order Block Settings
obPeriod = input.int(3, "OB Confirmation", minval=1, maxval=10, group="Order Block")
obExtend = input.int(20, "OB Extension", group="Order Block")

// Fibonacci Settings
fiboLookback = input.int(50, "Fibo Lookback", minval=10, maxval=500, group="Fibonacci")

// Ichimoku Settings
conversionPeriods = input.int(9, "Conversion Line Length", minval=1, group="Ichimoku Cloud")
basePeriods = input.int(26, "Base Line Length", minval=1, group="Ichimoku Cloud")
laggingSpan2Periods = input.int(52, "Leading Span B Length", minval=1, group="Ichimoku Cloud")
displacement = input.int(26, "Displacement", minval=1, group="Ichimoku Cloud")

// Volume Profile Settings
vpBars = input.int(150, "VP Bars", minval=1, maxval=500, group="Volume Profile")
vpRows = input.int(24, "VP Rows", minval=5, maxval=100, group="Volume Profile")

// Indicator Weights
weightEMA = input.int(2, "EMA Weight", minval=0, maxval=5, group="Weights")
weightMACD = input.int(2, "MACD Weight", minval=0, maxval=5, group="Weights")
weightRSI = input.int(1, "RSI Weight", minval=0, maxval=5, group="Weights")
weightMFI = input.int(1, "MFI Weight", minval=0, maxval=5, group="Weights")
weightSuperTrend = input.int(3, "SuperTrend Weight", minval=0, maxval=5, group="Weights")
weightBB = input.int(1, "Bollinger Bands Weight", minval=0, maxval=5, group="Weights")
weightOB = input.int(2, "Order Block/Fibo Weight", minval=0, maxval=5, group="Weights")
weightPOC = input.int(2, "POC Weight", minval=0, maxval=5, group="Weights")
weightIchimoku = input.int(3, "Ichimoku Weight", minval=0, maxval=5, group="Weights")

// Signal Settings
showSignals = input.bool(true, "Show Signals", group="Display")
showEMAs = input.bool(true, "Show EMAs", group="Display")
minScore = input.float(8.0, "Min Score", minval=0.0, maxval=50.0, step=0.5, group="Display")
confirmBars = input.int(2, "Confirm Bars", minval=1, maxval=5, group="Display")

// ═══════════════════════════════════════════════════════════════════════════
// CALCULATIONS - EMAs
// ═══════════════════════════════════════════════════════════════════════════

ema5_val = ta.ema(close, ema5)
ema10_val = ta.ema(close, ema10)
ema20_val = ta.ema(close, ema20)
ema50_val = ta.ema(close, ema50)
ema100_val = ta.ema(close, ema100)
ema200_val = ta.ema(close, ema200)

// EMA Trend Detection
emaUptrend = ema5_val > ema10_val and ema10_val > ema20_val and ema20_val > ema50_val
emaDowntrend = ema5_val < ema10_val and ema10_val < ema20_val and ema20_val < ema50_val
emaCrossUp = ta.crossover(ema5_val, ema20_val)
emaCrossDown = ta.crossunder(ema5_val, ema20_val)

// ═══════════════════════════════════════════════════════════════════════════
// CALCULATIONS - MACD
// ═══════════════════════════════════════════════════════════════════════════

[macdLine, signalLine, histLine] = ta.macd(close, macdFast, macdSlow, macdSignal)
macdCrossUp = ta.crossover(macdLine, signalLine)
macdCrossDown = ta.crossunder(macdLine, signalLine)
macdBullish = macdLine > signalLine and histLine > 0
macdBearish = macdLine < signalLine and histLine < 0

// ═══════════════════════════════════════════════════════════════════════════
// CALCULATIONS - RSI
// ═══════════════════════════════════════════════════════════════════════════

rsi = ta.rsi(close, rsiLength)
rsiOversoldZone = rsi < rsiOversold
rsiOverboughtZone = rsi > rsiOverbought
rsiBullish = rsi > 50 and rsi < rsiOverbought
rsiBearish = rsi < 50 and rsi > rsiOversold

// ═══════════════════════════════════════════════════════════════════════════
// CALCULATIONS - MFI
// ═══════════════════════════════════════════════════════════════════════════

mfi = ta.mfi(hlc3, mfiLength)
mfiOversoldZone = mfi < mfiOversold
mfiOverboughtZone = mfi > mfiOverbought
mfiBullish = mfi > 50 and mfi < mfiOverbought
mfiBearish = mfi < 50 and mfi > mfiOversold

// ═══════════════════════════════════════════════════════════════════════════
// CALCULATIONS - SuperTrend
// ═══════════════════════════════════════════════════════════════════════════

[supertrend, direction] = ta.supertrend(atrMultiplier, atrPeriod)
stUptrend = direction < 0
stDowntrend = direction > 0
stBuySignal = ta.change(direction) < 0
stSellSignal = ta.change(direction) > 0

// ═══════════════════════════════════════════════════════════════════════════
// CALCULATIONS - Bollinger Bands
// ═══════════════════════════════════════════════════════════════════════════

bbBasis = ta.sma(close, bbLength)
bbDev = bbMult * ta.stdev(close, bbLength)
bbUpper = bbBasis + bbDev
bbLower = bbBasis - bbDev

bbBounceUp = low <= bbLower and close > bbLower and close > open
bbBounceDown = high >= bbUpper and close < bbUpper and close < open
bbCrossUp = ta.crossover(close, bbBasis)
bbCrossDown = ta.crossunder(close, bbBasis)

// ═══════════════════════════════════════════════════════════════════════════
// CALCULATIONS - Order Block
// ═══════════════════════════════════════════════════════════════════════════

isBullish(index) => close[index] > open[index]
isBearish(index) => close[index] < open[index]

checkLowerHighs(startIndex, n) =>
    valid = true
    if startIndex < n
        valid := false
    else
        lastHigh = high[startIndex]
        for i = 1 to n
            if high[startIndex - i] >= lastHigh
                valid := false
                break
            lastHigh := high[startIndex - i]
    valid

checkHigherLows(startIndex, n) =>
    valid = true
    if startIndex < n
        valid := false
    else
        lastLow = low[startIndex]
        for i = 1 to n
            if low[startIndex - i] <= lastLow
                valid := false
                break
            lastLow := low[startIndex - i]
    valid

bearishOB = isBullish(obPeriod) and checkLowerHighs(obPeriod, obPeriod)
bullishOB = isBearish(obPeriod) and checkHigherLows(obPeriod, obPeriod)

// ═══════════════════════════════════════════════════════════════════════════
// CALCULATIONS - Fibonacci
// ═══════════════════════════════════════════════════════════════════════════

var float swingLow = na
var float swingHigh = na

lowestPrice = ta.lowest(low, fiboLookback)
if low == lowestPrice
    swingLow := low

highestPrice = ta.highest(high, fiboLookback)
if high == highestPrice
    swingHigh := high

var float fibo_618 = na
var float fibo_500 = na
var float fibo_382 = na

if not na(swingLow) and not na(swingHigh)
    diff = swingHigh - swingLow
    fibo_618 := swingHigh - (diff * 0.618)
    fibo_500 := swingHigh - (diff * 0.500)
    fibo_382 := swingHigh - (diff * 0.382)

inFiboBuyZone = not na(fibo_618) and close >= fibo_618 and close <= fibo_500
inFiboSellZone = not na(fibo_382) and close <= fibo_382 and close >= fibo_618

// ═══════════════════════════════════════════════════════════════════════════
// CALCULATIONS - Ichimoku Cloud
// ═══════════════════════════════════════════════════════════════════════════

donchian(len) => math.avg(ta.lowest(len), ta.highest(len))
conversionLine = donchian(conversionPeriods)
baseLine = donchian(basePeriods)
leadLine1 = math.avg(conversionLine, baseLine)
leadLine2 = donchian(laggingSpan2Periods)

// Calculate cloud for current bar (not displaced)
cloudTop = math.max(leadLine1[displacement - 1], leadLine2[displacement - 1])
cloudBottom = math.min(leadLine1[displacement - 1], leadLine2[displacement - 1])
bullishCloud = leadLine1 > leadLine2

// Ichimoku signals
tkCrossBullish = ta.crossover(conversionLine, baseLine)
tkCrossBearish = ta.crossunder(conversionLine, baseLine)
priceAboveCloud = close > cloudTop
priceBelowCloud = close < cloudBottom
priceInCloud = close >= cloudBottom and close <= cloudTop
cloudBreakBullish = ta.crossover(close, cloudTop)
cloudBreakBearish = ta.crossunder(close, cloudBottom)
chikouAbovePrice = close > close[displacement]
chikouBelowPrice = close < close[displacement]

// Ichimoku trend conditions
ichimokuBullish = priceAboveCloud and bullishCloud and chikouAbovePrice and conversionLine > baseLine
ichimokuBearish = priceBelowCloud and not bullishCloud and chikouBelowPrice and conversionLine < baseLine

// ═══════════════════════════════════════════════════════════════════════════
// CALCULATIONS - Volume Profile POC
// ═══════════════════════════════════════════════════════════════════════════

vpTop = ta.highest(vpBars)
vpBot = ta.lowest(vpBars)
vpStep = (vpTop - vpBot) / vpRows

vpLevels = array.new_float(vpRows + 1)
for x = 0 to vpRows
    array.set(vpLevels, x, vpBot + vpStep * x)

get_vol(y11, y12, y21, y22, height, vol) =>
    nz(math.max(math.min(math.max(y11, y12), math.max(y21, y22)) - math.max(math.min(y11, y12), math.min(y21, y22)), 0) * vol / height)

vpVolumes = array.new_float(vpRows * 2, 0.)
for bars = 0 to vpBars - 1
    body_top = math.max(close[bars], open[bars])
    body_bot = math.min(close[bars], open[bars])
    itsgreen = close[bars] >= open[bars]
    topwick = high[bars] - body_top
    bottomwick = body_bot - low[bars]
    body = body_top - body_bot
    bodyvol = body * volume[bars] / (2 * topwick + 2 * bottomwick + body)
    topwickvol = 2 * topwick * volume[bars] / (2 * topwick + 2 * bottomwick + body)
    bottomwickvol = 2 * bottomwick * volume[bars] / (2 * topwick + 2 * bottomwick + body)
    for x = 0 to vpRows - 1
        array.set(vpVolumes, x, array.get(vpVolumes, x) + (itsgreen ? get_vol(array.get(vpLevels, x), array.get(vpLevels, x + 1), body_bot, body_top, body, bodyvol) : 0) + get_vol(array.get(vpLevels, x), array.get(vpLevels, x + 1), body_top, high[bars], topwick, topwickvol) / 2 + get_vol(array.get(vpLevels, x), array.get(vpLevels, x + 1), body_bot, low[bars], bottomwick, bottomwickvol) / 2)
        array.set(vpVolumes, x + vpRows, array.get(vpVolumes, x + vpRows) + (itsgreen ? 0 : get_vol(array.get(vpLevels, x), array.get(vpLevels, x + 1), body_bot, body_top, body, bodyvol)) + get_vol(array.get(vpLevels, x), array.get(vpLevels, x + 1), body_top, high[bars], topwick, topwickvol) / 2 + get_vol(array.get(vpLevels, x), array.get(vpLevels, x + 1), body_bot, low[bars], bottomwick, bottomwickvol) / 2)

vpTotalVols = array.new_float(vpRows, 0.)
for x = 0 to vpRows - 1
    array.set(vpTotalVols, x, array.get(vpVolumes, x) + array.get(vpVolumes, x + vpRows))

pocIndex = array.indexof(vpTotalVols, array.max(vpTotalVols))
pocLevel = (array.get(vpLevels, pocIndex) + array.get(vpLevels, pocIndex + 1)) / 2

var bool wasAbovePOC = false
var bool wasBelowPOC = false

if close[1] > pocLevel
    wasAbovePOC := true
    wasBelowPOC := false
else if close[1] < pocLevel
    wasBelowPOC := true
    wasAbovePOC := false

pocBreakUp = wasBelowPOC and close > pocLevel
pocBreakDown = wasAbovePOC and close < pocLevel

// ═══════════════════════════════════════════════════════════════════════════
// LUPI SIGNAL LOGIC - ĐIỀU KIỆN VÀO LỆNH NHẠY VÀ CHÍNH XÁC
// ═══════════════════════════════════════════════════════════════════════════

// BUY CONDITIONS (Nhiều tín hiệu hội tụ)
buyCondition1 = emaCrossUp or (emaUptrend and close > ema20_val)
buyCondition2 = macdCrossUp or macdBullish
buyCondition3 = rsi > rsiOversold and rsi < 70 and ta.rising(rsi, 2)
buyCondition4 = mfi > mfiOversold and mfi < 70
buyCondition5 = stUptrend
buyCondition6 = (bbBounceUp or bbCrossUp or close > bbBasis)
buyCondition7 = bullishOB or inFiboBuyZone
buyCondition8 = pocBreakUp or close > pocLevel
buyCondition9 = ichimokuBullish or cloudBreakBullish or tkCrossBullish

// SELL CONDITIONS (Nhiều tín hiệu hội tụ)
sellCondition1 = emaCrossDown or (emaDowntrend and close < ema20_val)
sellCondition2 = macdCrossDown or macdBearish
sellCondition3 = rsi < rsiOverbought and rsi > 30 and ta.falling(rsi, 2)
sellCondition4 = mfi < mfiOverbought and mfi > 30
sellCondition5 = stDowntrend
sellCondition6 = (bbBounceDown or bbCrossDown or close < bbBasis)
sellCondition7 = bearishOB or inFiboSellZone
sellCondition8 = pocBreakDown or close < pocLevel
sellCondition9 = ichimokuBearish or cloudBreakBearish or tkCrossBearish

// Tính điểm cho mỗi tín hiệu với trọng số
buyScore = (buyCondition1 ? weightEMA : 0) + (buyCondition2 ? weightMACD : 0) + (buyCondition3 ? weightRSI : 0) + (buyCondition4 ? weightMFI : 0) + (buyCondition5 ? weightSuperTrend : 0) + (buyCondition6 ? weightBB : 0) + (buyCondition7 ? weightOB : 0) + (buyCondition8 ? weightPOC : 0) + (buyCondition9 ? weightIchimoku : 0)

sellScore = (sellCondition1 ? weightEMA : 0) + (sellCondition2 ? weightMACD : 0) + (sellCondition3 ? weightRSI : 0) + (sellCondition4 ? weightMFI : 0) + (sellCondition5 ? weightSuperTrend : 0) + (sellCondition6 ? weightBB : 0) + (sellCondition7 ? weightOB : 0) + (sellCondition8 ? weightPOC : 0) + (sellCondition9 ? weightIchimoku : 0)

// Tổng trọng số tối đa
maxScore = weightEMA + weightMACD + weightRSI + weightMFI + weightSuperTrend + weightBB + weightOB + weightPOC + weightIchimoku

// Tín hiệu cuối cùng
strongBuySignal = buyScore >= minScore and close > open
strongSellSignal = sellScore >= minScore and close < open

// Xác nhận tín hiệu qua nhiều bars để khử nhiễu
var int buyConfirmCount = 0
var int sellConfirmCount = 0

if strongBuySignal
    buyConfirmCount += 1
    sellConfirmCount := 0
else if strongSellSignal
    sellConfirmCount += 1
    buyConfirmCount := 0
else
    buyConfirmCount := 0
    sellConfirmCount := 0

confirmedBuySignal = buyConfirmCount >= confirmBars
confirmedSellSignal = sellConfirmCount >= confirmBars

// ═══════════════════════════════════════════════════════════════════════════
// ALTERNATION LOGIC - ĐẢM BẢO BUY VÀ SELL LUÂN PHIÊN
// ═══════════════════════════════════════════════════════════════════════════

var int lastSignalType = 0  // 0 = none, 1 = buy, -1 = sell

buySignal = confirmedBuySignal and lastSignalType != 1
sellSignal = confirmedSellSignal and lastSignalType != -1

if buySignal
    lastSignalType := 1
if sellSignal
    lastSignalType := -1

// ═══════════════════════════════════════════════════════════════════════════
// PLOTTING
// ═══════════════════════════════════════════════════════════════════════════

// Plot EMAs
plot(showEMAs ? ema5_val : na, "EMA 5", color=color.new(color.red, 0), linewidth=1)
plot(showEMAs ? ema10_val : na, "EMA 10", color=color.new(color.orange, 0), linewidth=1)
plot(showEMAs ? ema20_val : na, "EMA 20", color=color.new(color.yellow, 0), linewidth=2)
plot(showEMAs ? ema50_val : na, "EMA 50", color=color.new(color.blue, 0), linewidth=2)
plot(showEMAs ? ema100_val : na, "EMA 100", color=color.new(color.purple, 0), linewidth=2)
plot(showEMAs ? ema200_val : na, "EMA 200", color=color.new(color.white, 0), linewidth=3)

// Plot SuperTrend
upTrend = plot(direction < 0 ? supertrend : na, "SuperTrend Up", color=color.green, style=plot.style_linebr, linewidth=2)
downTrend = plot(direction < 0 ? na : supertrend, "SuperTrend Down", color=color.red, style=plot.style_linebr, linewidth=2)

// Plot Bollinger Bands
plot(bbBasis, "BB Basis", color=color.new(color.blue, 0), linewidth=1)
plot(bbUpper, "BB Upper", color=color.new(color.red, 50), linewidth=1)
plot(bbLower, "BB Lower", color=color.new(color.green, 50), linewidth=1)

// Plot POC Level
plot(pocLevel, "POC", color=color.new(color.white, 30), linewidth=2, style=plot.style_cross)

// Plot Fibonacci Levels
plot(showEMAs ? fibo_618 : na, "Fibo 61.8%", color=color.new(color.blue, 70), linewidth=1, style=plot.style_circles)
plot(showEMAs ? fibo_500 : na, "Fibo 50%", color=color.new(color.white, 70), linewidth=1, style=plot.style_circles)
plot(showEMAs ? fibo_382 : na, "Fibo 38.2%", color=color.new(color.yellow, 70), linewidth=1, style=plot.style_circles)

// Plot Ichimoku Cloud
p1 = plot(leadLine1, offset=displacement - 1, color=color.new(color.green, 70), title="Leading Span A", linewidth=1)
p2 = plot(leadLine2, offset=displacement - 1, color=color.new(color.red, 70), title="Leading Span B", linewidth=1)
fill(p1, p2, color=leadLine1 > leadLine2 ? color.new(color.green, 90) : color.new(color.red, 90), title="Ichimoku Cloud")
plot(conversionLine, color=color.new(color.blue, 0), title="Conversion Line", linewidth=1)
plot(baseLine, color=color.new(color.fuchsia, 0), title="Base Line", linewidth=1)
plot(close, offset=-displacement + 1, color=color.new(color.orange, 50), title="Lagging Span", linewidth=1)

// Plot Signals với labels động
if showSignals and buySignal
    // Tạo chi tiết các chỉ báo đóng góp
    details = ""
    details += buyCondition1 ? "✓EMA(" + str.tostring(weightEMA) + ")\n" : ""
    details += buyCondition2 ? "✓MACD(" + str.tostring(weightMACD) + ")\n" : ""
    details += buyCondition3 ? "✓RSI(" + str.tostring(weightRSI) + ")\n" : ""
    details += buyCondition4 ? "✓MFI(" + str.tostring(weightMFI) + ")\n" : ""
    details += buyCondition5 ? "✓ST(" + str.tostring(weightSuperTrend) + ")\n" : ""
    details += buyCondition6 ? "✓BB(" + str.tostring(weightBB) + ")\n" : ""
    details += buyCondition7 ? "✓OB/Fibo(" + str.tostring(weightOB) + ")\n" : ""
    details += buyCondition8 ? "✓POC(" + str.tostring(weightPOC) + ")\n" : ""
    details += buyCondition9 ? "✓Ichi(" + str.tostring(weightIchimoku) + ")\n" : ""
    
    label.new(bar_index, low, "BUY " + str.tostring(buyScore, '#.#') + "/" + str.tostring(maxScore) + "\n" + details, 
              style=label.style_label_up, 
              color=color.new(color.green, 0), 
              textcolor=color.white, 
              size=size.small,
              tooltip="Active Indicators:\n" + details)

if showSignals and sellSignal
    // Tạo chi tiết các chỉ báo đóng góp
    details = ""
    details += sellCondition1 ? "✓EMA(" + str.tostring(weightEMA) + ")\n" : ""
    details += sellCondition2 ? "✓MACD(" + str.tostring(weightMACD) + ")\n" : ""
    details += sellCondition3 ? "✓RSI(" + str.tostring(weightRSI) + ")\n" : ""
    details += sellCondition4 ? "✓MFI(" + str.tostring(weightMFI) + ")\n" : ""
    details += sellCondition5 ? "✓ST(" + str.tostring(weightSuperTrend) + ")\n" : ""
    details += sellCondition6 ? "✓BB(" + str.tostring(weightBB) + ")\n" : ""
    details += sellCondition7 ? "✓OB/Fibo(" + str.tostring(weightOB) + ")\n" : ""
    details += sellCondition8 ? "✓POC(" + str.tostring(weightPOC) + ")\n" : ""
    details += sellCondition9 ? "✓Ichi(" + str.tostring(weightIchimoku) + ")\n" : ""
    
    label.new(bar_index, high, "SELL " + str.tostring(sellScore, '#.#') + "/" + str.tostring(maxScore) + "\n" + details, 
              style=label.style_label_down, 
              color=color.new(color.red, 0), 
              textcolor=color.white, 
              size=size.small,
              tooltip="Active Indicators:\n" + details)

// Plot signals shapes (without dynamic text)
plotshape(showSignals and buySignal, "BUY Signal", shape.triangleup, location.belowbar, 
          color=color.new(color.green, 0), size=size.small)

plotshape(showSignals and sellSignal, "SELL Signal", shape.triangledown, location.abovebar, 
          color=color.new(color.red, 0), size=size.small)

// Background Color
bgcolor(buySignal ? color.new(color.green, 90) : na)
bgcolor(sellSignal ? color.new(color.red, 90) : na)

// ═══════════════════════════════════════════════════════════════════════════
// ALERTS
// ═══════════════════════════════════════════════════════════════════════════

alertcondition(buySignal, title="LUPI BUY Signal", message="LUPI BUY Signal Triggered")
alertcondition(sellSignal, title="LUPI SELL Signal", message="LUPI SELL Signal Triggered")
