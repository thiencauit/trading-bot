//@version=6
indicator(title="Chaikin Money Flow", shorttitle="CMF", format=format.price, precision=2, timeframe="", timeframe_gaps=true)
var cumVol = 0.
cumVol += nz(volume)
if barstate.islast and cumVol == 0
    runtime.error("No volume is provided by the data vendor.")
length = input.int(20, minval=1)
ad = close==high and close==low or high==low ? 0 : ((2*close-low-high)/(high-low))*volume
mf = math.sum(ad, length) / math.sum(volume, length)

// Detect peaks and valleys
pivot_lookback = input.int(5, "Pivot Lookback", minval=1)

// Find pivot highs (peaks) and pivot lows (valleys)
pivotHigh = ta.pivothigh(mf, pivot_lookback, pivot_lookback)
pivotLow = ta.pivotlow(mf, pivot_lookback, pivot_lookback)

// Store previous peaks and valleys
var float lastPeakValue = na
var float prevPeakValue = na
var float lastValleyValue = na
var float prevValleyValue = na

// Update peak values
if not na(pivotHigh)
    prevPeakValue := lastPeakValue
    lastPeakValue := pivotHigh

// Update valley values
if not na(pivotLow)
    prevValleyValue := lastValleyValue
    lastValleyValue := pivotLow

// Detect crossovers
crossAboveZero = ta.crossover(mf, 0)
crossBelowZero = ta.crossunder(mf, 0)

// Lower high: current peak is lower than previous peak
lowerHigh = not na(lastPeakValue) and not na(prevPeakValue) and lastPeakValue < prevPeakValue

// Higher low: current valley is higher than previous valley
higherLow = not na(lastValleyValue) and not na(prevValleyValue) and lastValleyValue > prevValleyValue

// Track last signal to ensure alternation
var string lastSignal = na

// Determine CMF trend using multiple bars for confirmation
cmfTrend = ta.sma(mf, 3) // Smooth trend
cmfRising = cmfTrend > cmfTrend[1] and cmfTrend[1] > cmfTrend[2] // Consistent uptrend
cmfFalling = cmfTrend < cmfTrend[1] and cmfTrend[1] < cmfTrend[2] // Consistent downtrend

// Momentum confirmation
cmfMomentum = mf - mf[1]
strongUpMomentum = cmfMomentum > 0 and cmfMomentum > cmfMomentum[1]
strongDownMomentum = cmfMomentum < 0 and cmfMomentum < cmfMomentum[1]

// Signal conditions with multiple confirmations
// SELL: At peak with downtrend confirmation OR lower high with strong down momentum
sellCondition = (not na(pivotHigh) and cmfFalling) or (lowerHigh and not na(pivotHigh) and strongDownMomentum) or (crossBelowZero and mf[1] > 0.1 and cmfFalling)

// BUY: At valley with uptrend confirmation OR higher low with strong up momentum  
buyCondition = (not na(pivotLow) and cmfRising) or (higherLow and not na(pivotLow) and strongUpMomentum) or (crossAboveZero and mf[1] < -0.1 and cmfRising)

// Apply alternation logic
buySignal = buyCondition and (na(lastSignal) or lastSignal == "SELL")
sellSignal = sellCondition and (na(lastSignal) or lastSignal == "BUY")

// Update last signal
if buySignal
    lastSignal := "BUY"
else if sellSignal
    lastSignal := "SELL"

// Plot CMF
plot(mf, "CMF", color = #43A047, linewidth=2)
hline(0, "Zero", color = #787B86, linestyle = hline.style_dashed)

// Plot signals with text
plotshape(buySignal, title="Strong BUY", text="BUY", style=shape.labelup, location=location.bottom, color=color.new(color.green, 0), textcolor=color.white, size=size.normal)
plotshape(sellSignal, title="Strong SELL", text="SELL", style=shape.labeldown, location=location.top, color=color.new(color.red, 0), textcolor=color.white, size=size.normal)

// Plot pivot points for visualization
plotshape(pivotHigh, "Peak", shape.diamond, location.absolute, color.red, size=size.tiny, offset=-pivot_lookback)
plotshape(pivotLow, "Valley", shape.diamond, location.absolute, color.green, size=size.tiny, offset=-pivot_lookback)

// Alerts
alertcondition(buySignal, title="CMF Buy Signal", message="CMF Buy: Cross above 0 or Higher Low")
alertcondition(sellSignal, title="CMF Sell Signal", message="CMF Sell: Cross below 0 or Lower High")