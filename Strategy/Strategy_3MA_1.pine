//@version=5
strategy("Triple MA 5-10-20 Strategy Ver2", overlay=true,process_orders_on_close = true,calc_on_order_fills = false)

// === Inputs ===
lenFast  = input.int(5,  "Fast MA (MA5)",  minval = 1)
lenMid   = input.int(10, "Mid MA (MA10)",  minval = 1)
lenSlow  = input.int(20, "Slow MA (MA20)", minval = 1)
src      = input.source(close, "Source")
useEMA   = input.bool(false, "Use EMA instead of SMA?")

dev_abs = close - open
dev_pct = (close - open) / open * 100.0
vol_avg20 = ta.sma(volume, 20) 
isVolumeOver = volume>=vol_avg20* 1.2
diff_reached = dev_pct >= 2

// === MA calculations ===
maFast = useEMA ? ta.ema(src, lenFast) : ta.sma(src, lenFast)
maMid  = useEMA ? ta.ema(src, lenMid)  : ta.sma(src, lenMid)
maSlow = useEMA ? ta.ema(src, lenSlow) : ta.sma(src, lenSlow)
smaSlow = ta.sma(src, lenSlow)
smaFast = ta.sma(src, lenFast)

// === long conditions ===
priceCrossOverMAFast = ta.crossover(src,maFast)
priceCrossOverMAMid = ta.crossover(src,maMid)
priceCrossOverMASlow = ta.crossover(src,maSlow)
priceCrossOverAllMA = priceCrossOverMAFast and priceCrossOverMAMid and priceCrossOverMASlow
priceOverMAFast = src > maFast
priceOverMAMid = src > maMid
priceOverMASlow = src > maSlow
priceOverAllMA = priceOverMAFast and priceOverMAMid and priceOverMASlow

maFastOverMAMid = maFast>=maMid
maMidOverMASlow = maMid>=maSlow

maFastCrossOverMAMid = ta.crossover(maFast,maMid)
maMidCrossOverMASlow = ta.crossover(maMid,maSlow)
maFastCrossOverMASlow = ta.crossover(maFast,maSlow)

maFastOverPast = maFast > maFast[2] and src > src[1]
maMidOverPast = maMid>maMid[3]
maSlowOverPast = maSlow > maSlow[3]

// === short conditions ===
priceCrossUnderMAFast = ta.crossunder(src,maFast)
priceCrossUnderMAMid = ta.crossunder(src,maMid)
priceCrossUnderMASlow = ta.crossunder(src,maSlow)
priceCrossUnderAllMA = priceCrossUnderMAFast and priceCrossUnderMAMid and priceCrossUnderMASlow
priceCrossUnderSMASlow = ta.crossunder(src,smaSlow)
priceUnderSMASlow = src < smaSlow
priceUnderMAFast = src < maFast
priceUnderMAMid = src < maMid

maFastUnderMAMid = maFast<maMid 
maMidUnderMASlow = maMid<maSlow
maFastUnderMASlow = maFast < maSlow

maFastCrossUnderMAMid = ta.crossunder(maFast,maMid)
maMidCrossUnderMASlow = ta.crossunder(maMid,maSlow)
maFastCrossUnderMaSlow = ta.crossunder(maFast,maSlow)
maFastUnderPast = maFast < maFast[5]
maMidUnderPast = maMid < maMid[3]
maSlowUnderPast = maSlow < maSlow[3]

priceUnderMaMidAndMaFastCrossUnderMaMid = (maFastUnderPast and maMidUnderPast)


ma100 = useEMA ? ta.ema(src, 100) : ta.sma(src, 100)
ma200 = useEMA ? ta.ema(src, 200) : ta.sma(src, 200)
ma50 = useEMA ? ta.ema(src, 50) : ta.sma(src, 50)
isUpTrend = maFast > ma50 
isDownTrend = ma100 < ma200
//=====long condition======
l1 = priceCrossOverMAFast and priceCrossOverMAMid
l2 = maFastCrossOverMAMid or maFastCrossOverMASlow

isLong = l1 or l2 
if(l1==true and l2 ==true and maMidUnderPast) 
    isLong := isLong and isVolumeOver

//======short condition==============
s1 = priceCrossUnderMAFast and priceCrossUnderMAMid and (isVolumeOver or (maFast < maFast[1]))
s2 = (maFastCrossUnderMAMid) or (maFastUnderPast and maMidUnderPast)
s3 = priceUnderMAMid and src < src[1]

bearishCandle = close < open
isShort = (s1 or s2) and bearishCandle
isLong := maFastCrossOverMAMid or maFastCrossOverMASlow
isShort := maFastCrossUnderMAMid or maFastCrossUnderMaSlow
// if(s1 and isVolumeOver)
//     isShort:= isShort and diff_reached
//==================================
// === State tracking (luân phiên) ===
// inLong = true  -> đang giữ lệnh Long
// inLong = false -> đang flat (không lệnh)
var bool inLong = false

// Chỉ cho phép BUY nếu đang flat
buySignal  = isLong and (inLong == false) 

// Chỉ cho phép SELL nếu đang giữ lệnh
sellSignal = isShort and (inLong == true)


// === Orders ===
if (buySignal)
    strategy.entry("Long", strategy.long)
    inLong := true

if (sellSignal)
    strategy.close("Long")
    inLong := false

// === Plot MAs ===
plot(maFast, "MA Fast (5)",  color=color.yellow,  linewidth=1)
plot(maMid,  "MA Mid (10)",  color=color.orange,  linewidth=1)
plot(maSlow, "MA Slow (20)", color=color.red,     linewidth=1)

// === Plot Buy/Sell markers ===
// chỉ plot marker khi tín hiệu thực sự hợp lệ (sau lọc luân phiên)
plotshape(buySignal,  title="BUY",  text="BUY",  style=shape.labelup,   location=location.belowbar, color=color.lime,  size=size.tiny, textcolor=color.black)
plotshape(sellSignal, title="SELL", text="SELL", style=shape.labeldown, location=location.abovebar, color=color.red,   size=size.tiny, textcolor=color.white)